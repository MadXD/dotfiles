#!/usr/bin/env python2.7

import json
import os
import os.path
import sys


HERE = os.path.dirname(os.path.abspath(__file__))


def main():
    with open(os.path.join(HERE, 'install.json'), 'r') as f:
        manifest = json.load(f)

    process_entries(manifest['any'])
    process_entries(manifest[sys.platform])


def process_entries(entries):
    for entry in entries:
        install(entry['source'], entry['dest'])


def install(top, dest):
    def visit(_, directory, entries):
        for entry in [os.path.join(directory, f) for f in entries]:
            if not os.path.isdir(entry):
                symlink(os.path.join(HERE, entry), os.path.join(os.path.expanduser(dest), os.path.relpath(entry, start=top)))

    os.path.walk(top, visit, None)


def symlink(source, dest):
    if not os.path.exists(os.path.dirname(dest)):
        os.makedirs(os.path.dirname(dest))

    if os.path.lexists(dest):
        os.unlink(dest)

    os.symlink(source, dest)

    # print source, '->', dest


if __name__ == '__main__':
    main()
